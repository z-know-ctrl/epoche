
<!doctype html><html lang="en"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>epochē · Student</title>
<link rel="manifest" href="manifest.webmanifest"><meta name="theme-color" content="#2563eb">
<link rel="icon" href="../icon-192.png">
<style>
:root{--bg:#f8f9fb;--fg:#111;--accent:#2563eb;--muted:#6b7280;--card:#fff;--shadow:0 6px 24px rgba(0,0,0,.08)}
@media (prefers-color-scheme: dark){:root{--bg:#0b0c0f;--fg:#f2f4f8;--accent:#60a5fa;--muted:#9aa3af;--card:#151821;--shadow:0 6px 24px rgba(0,0,0,.5)}}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,Apple SD Gothic Neo,'맑은 고딕',sans-serif}
.wrap{min-height:100%;display:grid;grid-template-rows:auto 1fr auto}
header{display:flex;align-items:center;justify-content:center;padding:8px 12px 0}
header img{max-width:440px;width:min(70vw,440px);height:auto}
main{display:flex;align-items:center;justify-content:center;padding:12px 16px}
#display{width:100%;max-width:900px;text-align:center;line-height:1.25;margin:0 auto;padding:16px;border-radius:20px;background:var(--card);
box-shadow:var(--shadow);font-size:clamp(24px,6vw,56px);letter-spacing:.2px;opacity:0;transform:translateY(-10px);transition:opacity .4s,transform .4s;min-height:3.2em}
@keyframes slideFade{0%{opacity:0;transform:translateY(-14px)}50%{opacity:1;transform:translateY(4px)}100%{opacity:1;transform:translateY(0)}}
.btn{background:var(--accent);color:#fff;border:0;border-radius:14px;font-size:clamp(15px,3.6vw,18px);padding:14px 16px;min-height:48px;font-weight:600;box-shadow:0 4px 14px rgba(37,99,235,.25)}
.btn.secondary{background:var(--card);color:var(--fg);border:1px solid rgba(0,0,0,.08);box-shadow:none}
select,input[type="number"],textarea{padding:10px 12px;min-height:44px;border-radius:12px;border:1px solid rgba(0,0,0,.15);background:var(--card);color:var(--fg)}
.meta{text-align:center;font-size:13px;color:var(--muted);margin-top:8px;grid-column:1/-1}

.controls{position:sticky;bottom:0;z-index:10;width:100%;background:linear-gradient(180deg,rgba(0,0,0,0) 0%,rgba(0,0,0,.02) 12%),var(--bg);
border-top:1px solid rgba(0,0,0,.06);padding:12px 14px calc(12px + env(safe-area-inset-bottom));display:grid;grid-template-columns:auto auto auto 1fr auto auto auto;gap:10px}
@media (max-width:720px){.controls{grid-template-columns:1fr 1fr 1fr}}
</style></head><body>
<div class="wrap">
<header><img src="../icon-192.png" alt="epochē logo"></header>
<main><div id="display"></div></main>

<footer class="controls">
  <select id="levelSelect"><option value="all">Level: All</option><option value="1">Level 1</option><option value="2">Level 2</option><option value="3">Level 3</option></select>
  <select id="typeSelect"><option value="all">Type: All</option><option value="Adj Phrase">형용사구 (Adj Phrase)</option><option value="Adj Clause">형용사절 (Adj Clause)</option></select>
  <button id="filterBtn" class="btn secondary">Apply</button>
  <div style="display:grid;grid-template-columns:1fr auto;gap:8px">
    <input id="jumpInput" type="number" inputmode="numeric" pattern="[0-9]*" min="1" placeholder="#">
    <button id="jumpBtn" class="btn secondary">Go</button>
  </div>
  <button id="startBtn" class="btn">Start</button>
  <button id="nextSentenceBtn" class="btn">Next</button>
  <button id="updateBtn" class="btn secondary">Update</button>
  <button id="refreshAppBtn" class="btn secondary">Refresh app</button>
  <div class="meta" id="counter">Sentence 0 / 0</div>
</footer>
</div>

<script>
const FALLBACK_DATA = [{"level": 1, "type": "Adj Phrase", "text": "The boy in the blue shirt is my cousin."}, {"level": 1, "type": "Adj Phrase", "text": "The book on the table is mine."}, {"level": 1, "type": "Adj Phrase", "text": "The girl with long hair sings well."}, {"level": 1, "type": "Adj Clause", "text": "The boy who sits by the window is new."}, {"level": 2, "type": "Adj Clause", "text": "The shoes that I bought yesterday fit well."}, {"level": 3, "type": "Adj Clause", "text": "The city that I dreamed of visiting finally feels real."}];
const STORAGE_KEY = "epoche.levels.v1";

async function fetchRemote(){
  try{
    const res = await fetch('../data/sentences.json', {cache:'no-store'});
    if(!res.ok) throw new Error('net');
    const arr = await res.json();
    if(!Array.isArray(arr)) throw new Error('bad');
    return arr;
  }catch(e){ return null; }
}

let DATA = [];
try{ const local = localStorage.getItem(STORAGE_KEY); DATA = local ? JSON.parse(local) : FALLBACK_DATA.slice(); if(!Array.isArray(DATA)||DATA.length===0) DATA=FALLBACK_DATA.slice(); }
catch(e){ DATA=FALLBACK_DATA.slice(); }

const display=document.getElementById('display'); const counter=document.getElementById('counter');
const levelSelect=document.getElementById('levelSelect'); const typeSelect=document.getElementById('typeSelect');
const filterBtn=document.getElementById('filterBtn'); const jumpInput=document.getElementById('jumpInput'); const jumpBtn=document.getElementById('jumpBtn');
const startBtn=document.getElementById('startBtn'); const nextSentenceBtn=document.getElementById('nextSentenceBtn');
const updateBtn=document.getElementById('updateBtn'); const refreshAppBtn=document.getElementById('refreshAppBtn');

let filtered=DATA.slice(); let idx=0; let wordIndex=0; let wordGroups=[]; let isRunning=false;

function applyFilter(){ const lv=levelSelect.value; const tp=typeSelect.value;
  filtered = DATA.filter(s=>(lv==='all'||String(s.level)===lv)&&(tp==='all'||s.type===tp)); idx=0; updateCounter(); }
function updateCounter(){ const total=filtered.length; const current=total===0?0:(idx%total)+1; counter.textContent=`Sentence ${current} / ${total}`; }
function groupWords(sentence){ const words=sentence.split(" "); const groups=[]; let i=0;
  while(i<words.length){ const w=words[i].toLowerCase(); if((w==='a'||w==='an'||w==='the')&&i+1<words.length){groups.push(words[i]+" "+words[i+1]); i+=2;} else {groups.push(words[i]); i+=1;} } return groups; }
function speakWord(word){ try{ const u=new SpeechSynthesisUtterance(word); u.lang='en-US'; speechSynthesis.cancel(); speechSynthesis.speak(u); }catch(e){} }
function showNextWord(){ if(wordIndex>=wordGroups.length){ isRunning=false; startBtn.disabled=false; return; }
  const word=wordGroups[wordIndex]; display.style.opacity=0; display.style.transform='translateY(-8px)'; display.style.animation='none';
  setTimeout(()=>{ display.textContent=word; display.style.opacity=1; display.style.animation='slideFade .6s ease'; speakWord(word); wordIndex++; setTimeout(showNextWord, 1200); },200); }
function loadSentence(i){ if(filtered.length===0){ display.textContent='No sentences'; return; }
  const s=filtered[i%filtered.length]; const header=`[L${s.level} · ${s.type}] `; wordGroups=groupWords(header+s.text); wordIndex=0; isRunning=true; startBtn.disabled=true; updateCounter(); setTimeout(showNextWord,250); }
function playAndAdvance(){ if(isRunning) return; loadSentence(idx); idx=(idx+1)%Math.max(1,filtered.length); }

filterBtn.addEventListener('click', applyFilter); startBtn.addEventListener('click', playAndAdvance); nextSentenceBtn.addEventListener('click', playAndAdvance);
jumpBtn.addEventListener('click', ()=>{ if(isRunning) return; const n=parseInt(jumpInput.value,10); if(!isNaN(n)&&filtered.length>0){ idx=Math.max(0,Math.min(filtered.length-1,n-1)); playAndAdvance(); } });
jumpInput.addEventListener('keydown', e=>{ if(e.key==='Enter') jumpBtn.click(); }); applyFilter();

// Update from server
updateBtn.addEventListener('click', async ()=>{
  const remote = await fetchRemote();
  if(!remote) return alert('업데이트 실패. 네트워크 또는 /data/sentences.json 확인');
  DATA = remote; localStorage.setItem(STORAGE_KEY, JSON.stringify(DATA)); applyFilter(); alert('업데이트 완료!');
});

// SW refresh
if('serviceWorker' in navigator){
  window.addEventListener('load', ()=>navigator.serviceWorker.register('./sw.js'));
  refreshAppBtn.addEventListener('click', async ()=>{
    const regs = await navigator.serviceWorker.getRegistrations();
    for (const reg of regs) { reg.update(); if (reg.waiting) { reg.waiting.postMessage({type:'SKIP_WAITING'}); } }
    location.reload();
  });
}
</script>
</body></html>
